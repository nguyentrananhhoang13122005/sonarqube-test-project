name: SonarQube Analysis (DEBUGGING)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sonarqube-debug:
    name: SonarQube Debug and Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # =================================================================
      # B∆Ø·ªöC G·ª† L·ªñI ƒê·∫∂C BI·ªÜT
      # =================================================================
      - name: üß™ DEBUG - Test API Connection and Token
        run: |
          echo "--- B∆Ø·ªöC 1: KI·ªÇM TRA K·∫æT N·ªêI ƒê·∫æN SERVER (KH√îNG C·∫¶N TOKEN) ---"
          # L·ªánh curl -v s·∫Ω hi·ªÉn th·ªã chi ti·∫øt qu√° tr√¨nh k·∫øt n·ªëi
          curl -v "${{ secrets.SONAR_HOST_URL }}/api/system/health"
          
          echo ""
          echo "--- B∆Ø·ªöC 2: KI·ªÇM TRA X√ÅC TH·ª∞C B·∫∞NG TOKEN ---"
          # L·ªánh curl -u s·∫Ω d√πng token ƒë·ªÉ x√°c th·ª±c. 
          # L·ªánh -f s·∫Ω b√°o l·ªói n·∫øu server tr·∫£ v·ªÅ l·ªói (nh∆∞ 403)
          curl -v -f -u "${{ secrets.SONAR_TOKEN }}:" "${{ secrets.SONAR_HOST_URL }}/api/user_tokens/search"

      # =================================================================
      # B∆∞·ªõc qu√©t SonarQube g·ªëc (c√≥ th·ªÉ s·∫Ω th·∫•t b·∫°i l·∫ßn n·ªØa)
      # =================================================================
      - name: SonarQube Scan
        if: always() # Lu√¥n ch·∫°y b∆∞·ªõc n√†y d√π b∆∞·ªõc DEBUG c√≥ th·∫•t b·∫°i hay kh√¥ng
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
